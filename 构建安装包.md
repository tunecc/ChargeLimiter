# 构建安装包指南

本文档记录用于生成三个安装包（TrollStore `.tipa`、roothide `.deb`、rootful `.deb`）的完整流程、易错点与踩坑修复，便于后续发布和复现。

## 1. 产物与命名

输出目录统一使用 `out/`，不要创建 `LatestBuild 2/3/4` 等重复目录。

- TrollStore: `out/ChargeLimiter_<VERSION>_TrollStore.tipa`
- roothide: `out/ChargeLimiter_<VERSION>_roothide_arm64e.deb`
- rootful: `out/ChargeLimiter_<VERSION>_rootful_arm64.deb`

> 说明：`<VERSION>` 以 `MARKETING_VERSION` 为准（当前为 1.9.0）。

## 2. 必备依赖

- Xcode（含 Command Line Tools）
- `xcodebuild`
- `dpkg-deb`（可通过 Homebrew 安装）
- `zip`

```bash
brew install dpkg
```

## 3. 打包前检查点（非常重要）

- `MARKETING_VERSION` 已更新（`ChargeLimiter.xcodeproj/project.pbxproj`）。
- 两套 `DEBIAN/control` 的 `Package / Version / Architecture / Author` 已更新。
- **包名**：当前使用 `com.chargelimiter.mod`（避免与原作者冲突）。
- **语言包**：必须复制 **完整 `.app`** 到打包目录，否则 `.lproj` 会丢失。
- 清理 `.DS_Store`，否则 dpkg 安装会失败：

```bash
find ChargeLimiter/Package_rootless -name .DS_Store -delete
find ChargeLimiter/Package -name .DS_Store -delete
```

- 确保 `DEBIAN` 脚本可执行：

```bash
chmod 755 ChargeLimiter/Package_rootless/DEBIAN/*
chmod 755 ChargeLimiter/Package/DEBIAN/*
```

## 4. 标准打包流程（按顺序）

### 4.1 构建 App

```bash
rm -rf build Payload
xcodebuild -scheme "ChargeLimiter" -configuration Release -derivedDataPath build CODE_SIGNING_ALLOWED=NO ARCHS=arm64
```

注意：MonkeyDev 的脚本阶段可能尝试通过 SSH 上传产物，失败会报错但 **不影响 `.app` 生成**。可忽略或通过环境变量关闭：

```
MonkeyDevInstallOnAnyBuild=NO
MonkeyDevBuildPackageOnAnyBuild=NO
```

### 4.2 生成 TrollStore `.tipa`

```bash
mkdir -p Payload out
cp -a build/Build/Products/Release-iphoneos/ChargeLimiter.app Payload/ChargeLimiter.app
zip -r out/ChargeLimiter_<VERSION>_TrollStore.tipa Payload
rm -rf Payload
```

### 4.3 生成 roothide `.deb`（arm64e）

```bash
rm -rf ChargeLimiter/Package_rootless/var/jb/Applications/ChargeLimiter.app
cp -a build/Build/Products/Release-iphoneos/ChargeLimiter.app \
  ChargeLimiter/Package_rootless/var/jb/Applications/ChargeLimiter.app

dpkg-deb -Zxz -b ChargeLimiter/Package_rootless out/ChargeLimiter_<VERSION>_roothide_arm64e.deb
```

### 4.4 生成 rootful `.deb`（arm64）

```bash
rm -rf ChargeLimiter/Package/Applications/ChargeLimiter.app
cp -a build/Build/Products/Release-iphoneos/ChargeLimiter.app \
  ChargeLimiter/Package/Applications/ChargeLimiter.app

dpkg-deb -Zxz -b ChargeLimiter/Package out/ChargeLimiter_<VERSION>_rootful_arm64.deb
```

## 5. 常见问题与修复

- **TrollStore 安装提示“无法在 IPA 中找到应用程序包”**：
  - `Payload/ChargeLimiter.app` 路径不正确或 zip 结构错误。

- **dpkg 安装失败：`unable to open '/var/jb/.DS_Store.dpkg-new'`**：
  - `.DS_Store` 未清理，按第 3 节清理后重打包。

- **dpkg 警告 `unusual owner or group`**：
  - 通常可忽略，不影响安装；也可用 `dpkg-deb --root-owner-group` 消除。

- **语言包缺失（只剩 Base.lproj）**：
  - 原因：只拷贝了二进制没拷贝完整 `.app`。
  - 解决：必须 `cp -a` 完整 `.app`。

- **版本号仍显示旧号**：
  - `.app/Info.plist` 未同步或未重新构建。

- **rootful / roothide 路径混用**：
  - roothide: `/var/jb/Applications/ChargeLimiter.app`
  - rootful: `/Applications/ChargeLimiter.app`

## 6. 发布建议

- 先本机安装测试（安装 / 卸载 / 重启 daemon / 图标刷新）。
- 避免使用原作者包名，防止覆盖或更新冲突。
- 若有更新日志，请同步到 `docs/refactor/REFACTOR_CHANGES_LOG.txt`。

